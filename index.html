<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>TradeScope - Journal de Trading</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;1,9..40,400&family=Instrument+Sans:wght@400;500;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #08090E;
            --bg-secondary: #0E1018;
            --bg-card: #13151F;
            --bg-card-hover: #181B28;
            --sidebar-bg: #0B0C14;
            --accent: #3B82F6;
            --accent-dim: rgba(59, 130, 246, 0.12);
            --accent-glow: rgba(59, 130, 246, 0.25);
            --green: #22C55E;
            --green-dim: rgba(34, 197, 94, 0.12);
            --red: #EF4444;
            --red-dim: rgba(239, 68, 68, 0.12);
            --amber: #F59E0B;
            --text-1: #F0F2F5;
            --text-2: #8B92A5;
            --text-3: #4B5269;
            --border: rgba(255, 255, 255, 0.06);
            --border-hover: rgba(255, 255, 255, 0.12);
            --radius: 10px;
            --radius-lg: 14px;
            --font-display: 'Instrument Sans', sans-serif;
            --font-body: 'DM Sans', sans-serif;
            --font-mono: 'Space Mono', monospace;
            --transition: 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        [data-theme="light"] {
            --bg-primary: #F4F5F7; --bg-secondary: #FFFFFF; --bg-card: #FFFFFF;
            --bg-card-hover: #F8F9FB; --sidebar-bg: #FAFBFC;
            --green: #16A34A; --green-dim: rgba(22, 163, 74, 0.08);
            --red: #DC2626; --red-dim: rgba(220, 38, 38, 0.08);
            --accent-dim: rgba(59, 130, 246, 0.08); --accent-glow: rgba(59, 130, 246, 0.15);
            --text-1: #111318; --text-2: #6B7280; --text-3: #C4C9D4;
            --border: rgba(0, 0, 0, 0.06); --border-hover: rgba(0, 0, 0, 0.12);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: var(--font-body); background: var(--bg-primary); color: var(--text-1); overflow-x: hidden; -webkit-font-smoothing: antialiased; }
        ::selection { background: var(--accent); color: white; }
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--text-3); border-radius: 3px; }
        .app-container { display: flex; height: 100vh; }

        /* SIDEBAR */
        .sidebar { width: 240px; background: var(--sidebar-bg); border-right: 1px solid var(--border); display: flex; flex-direction: column; position: fixed; left: 0; top: 0; height: 100vh; z-index: 100; transition: transform 0.3s ease; }
        .mobile-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); z-index: 99; }
        .mobile-overlay.active { display: block; }
        .mobile-menu-btn { display: none; background: var(--bg-card); border: 1px solid var(--border); color: var(--text-1); width: 38px; height: 38px; border-radius: var(--radius); font-size: 1.2rem; cursor: pointer; align-items: center; justify-content: center; transition: var(--transition); }
        .mobile-only { display: none; }
        .logo { padding: 1.5rem 1.25rem; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 0.6rem; }
        .logo-mark { width: 32px; height: 32px; background: linear-gradient(135deg, var(--accent), #818CF8); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 0.85rem; color: white; font-weight: 700; box-shadow: 0 4px 12px var(--accent-glow); }
        .logo-text { font-family: var(--font-display); font-size: 1.15rem; font-weight: 700; letter-spacing: -0.02em; }
        .logo-text span { color: var(--text-2); font-weight: 500; font-size: 0.7rem; margin-left: 0.25rem; }
        .sidebar-menu { flex: 1; padding: 0.75rem; overflow-y: auto; }
        .menu-section { margin-bottom: 1.25rem; }
        .menu-label { font-size: 0.62rem; color: var(--text-3); text-transform: uppercase; letter-spacing: 1.5px; font-weight: 600; margin-bottom: 0.4rem; padding: 0 0.75rem; font-family: var(--font-mono); }
        .menu-item { display: flex; align-items: center; gap: 0.65rem; padding: 0.6rem 0.75rem; border-radius: 8px; cursor: pointer; transition: var(--transition); color: var(--text-2); font-weight: 500; font-size: 0.88rem; position: relative; }
        .menu-item:hover { background: var(--accent-dim); color: var(--text-1); }
        .menu-item.active { background: var(--accent-dim); color: var(--accent); font-weight: 600; }
        .menu-item.active::before { content: ''; position: absolute; left: 0; top: 50%; transform: translateY(-50%); width: 3px; height: 18px; background: var(--accent); border-radius: 0 3px 3px 0; }
        .menu-icon { font-size: 1.05rem; width: 22px; text-align: center; }
        .account-selector { padding: 0.75rem; border-top: 1px solid var(--border); }
        .account-btn { width: 100%; background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; padding: 0.65rem 0.75rem; color: var(--text-1); font-weight: 600; font-size: 0.82rem; cursor: pointer; display: flex; align-items: center; justify-content: space-between; transition: var(--transition); font-family: var(--font-body); }
        .account-btn:hover { border-color: var(--accent); }
        .account-btn span:last-child { color: var(--text-3); font-size: 0.7rem; }

        /* MAIN */
        .main-content { margin-left: 240px; flex: 1; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        .top-bar { background: var(--bg-secondary); border-bottom: 1px solid var(--border); padding: 0.85rem 1.75rem; display: flex; justify-content: space-between; align-items: center; min-height: 58px; }
        .top-bar-left { display: flex; align-items: center; gap: 1rem; }
        .page-title { font-size: 1.15rem; font-weight: 700; font-family: var(--font-display); letter-spacing: -0.02em; }
        .active-account-chip { display: flex; align-items: center; gap: 0.5rem; padding: 0.35rem 0.85rem; background: var(--accent-dim); border: 1px solid rgba(59,130,246,0.15); border-radius: 20px; cursor: pointer; transition: var(--transition); font-size: 0.82rem; }
        .active-account-chip:hover { border-color: var(--accent); }
        .acc-name { font-weight: 700; color: var(--text-1); }
        .acc-firm { color: var(--text-2); font-size: 0.75rem; }
        .acc-dot { width: 6px; height: 6px; background: var(--green); border-radius: 50%; }
        .top-actions { display: flex; gap: 0.5rem; align-items: center; }

        .btn { background: var(--accent); color: white; border: none; border-radius: 8px; padding: 0.55rem 1.15rem; font-weight: 600; cursor: pointer; transition: var(--transition); font-size: 0.85rem; font-family: var(--font-body); display: inline-flex; align-items: center; gap: 0.4rem; }
        .btn:hover { opacity: 0.9; transform: translateY(-1px); box-shadow: 0 4px 16px var(--accent-glow); }
        .btn:active { transform: translateY(0); }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text-2); }
        .btn-outline:hover { border-color: var(--accent); color: var(--accent); background: var(--accent-dim); box-shadow: none; opacity: 1; }
        .btn-icon { background: var(--bg-card); border: 1px solid var(--border); color: var(--text-2); width: 36px; height: 36px; padding: 0; display: flex; align-items: center; justify-content: center; border-radius: 8px; cursor: pointer; transition: var(--transition); font-size: 1rem; }
        .btn-icon:hover { border-color: var(--accent); color: var(--accent); background: var(--accent-dim); }

        .content-area { flex: 1; overflow-y: auto; padding: 1.5rem; }
        .view { display: none; }
        .view.active { display: block; animation: fadeUp 0.3s ease; }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

        /* DASHBOARD */
        .dashboard-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 1.5rem; }
        .metric-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 1.25rem; transition: var(--transition); position: relative; overflow: hidden; }
        .metric-card:hover { border-color: var(--border-hover); transform: translateY(-2px); }
        .metric-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px; background: linear-gradient(90deg, transparent, var(--accent), transparent); opacity: 0; transition: opacity var(--transition); }
        .metric-card:hover::before { opacity: 1; }
        .metric-label { font-size: 0.68rem; color: var(--text-3); text-transform: uppercase; letter-spacing: 1.2px; font-weight: 600; font-family: var(--font-mono); margin-bottom: 0.75rem; }
        .metric-value { font-size: 1.65rem; font-weight: 700; font-family: var(--font-display); letter-spacing: -0.03em; line-height: 1.1; margin-bottom: 0.4rem; }
        .metric-sub { font-size: 0.78rem; color: var(--text-2); font-weight: 500; display: flex; align-items: center; gap: 0.35rem; }
        .tag { display: inline-flex; align-items: center; gap: 0.2rem; padding: 0.15rem 0.45rem; border-radius: 4px; font-size: 0.72rem; font-weight: 700; font-family: var(--font-mono); }
        .tag.up { background: var(--green-dim); color: var(--green); }
        .tag.down { background: var(--red-dim); color: var(--red); }

        .dashboard-bottom { display: grid; grid-template-columns: 1fr 300px; gap: 1rem; }
        .card { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-lg); overflow: hidden; }
        .card-header { display: flex; justify-content: space-between; align-items: center; padding: 1rem 1.25rem; border-bottom: 1px solid var(--border); }
        .card-title { font-size: 0.92rem; font-weight: 700; font-family: var(--font-display); letter-spacing: -0.01em; }
        .card-body { padding: 1.25rem; }

        .calendar-nav { display: flex; gap: 0.35rem; }
        .calendar-nav button { background: var(--bg-secondary); border: 1px solid var(--border); color: var(--text-2); width: 30px; height: 30px; border-radius: 6px; cursor: pointer; font-size: 0.85rem; transition: var(--transition); display: flex; align-items: center; justify-content: center; }
        .calendar-nav button:hover { border-color: var(--accent); color: var(--accent); }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .calendar-day-header { text-align: center; font-size: 0.62rem; color: var(--text-3); font-weight: 700; padding: 0.4rem; text-transform: uppercase; letter-spacing: 1px; font-family: var(--font-mono); }
        .calendar-day { aspect-ratio: 1; background: var(--bg-secondary); border: 1px solid transparent; border-radius: 6px; padding: 4px; cursor: default; transition: var(--transition); display: flex; flex-direction: column; justify-content: space-between; position: relative; }
        .calendar-day:hover { border-color: var(--border-hover); }
        .calendar-day.today { border-color: var(--accent); box-shadow: 0 0 0 1px var(--accent); }
        .calendar-day.profit { background: var(--green-dim); border-color: rgba(34,197,94,0.15); }
        .calendar-day.loss { background: var(--red-dim); border-color: rgba(239,68,68,0.15); }
        .calendar-day.has-trades { cursor: pointer; }
        .calendar-day.has-trades:hover { transform: scale(1.08); z-index: 2; }
        .calendar-day-number { font-size: 0.75rem; font-weight: 600; color: var(--text-3); }
        .calendar-day.has-trades .calendar-day-number { color: var(--text-1); }
        .calendar-day-pnl { font-size: 0.65rem; font-weight: 700; text-align: center; font-family: var(--font-mono); }
        .calendar-day-trades { font-size: 0.58rem; color: var(--text-3); text-align: center; }

        .week-item { padding: 0.85rem; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; margin-bottom: 0.5rem; transition: var(--transition); }
        .week-item:hover { border-color: var(--border-hover); }
        .week-label { font-size: 0.68rem; color: var(--text-3); margin-bottom: 0.3rem; font-family: var(--font-mono); text-transform: uppercase; letter-spacing: 0.5px; }
        .week-pnl { font-size: 1.2rem; font-weight: 700; font-family: var(--font-display); letter-spacing: -0.02em; margin-bottom: 0.1rem; }
        .week-stats { font-size: 0.78rem; color: var(--text-2); }

        /* TRADES TABLE */
        .trades-container { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-lg); overflow: hidden; }
        .trades-header { padding: 1rem 1.25rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .filter-pills { display: flex; gap: 0.35rem; }
        .filter-pill { padding: 0.4rem 0.85rem; background: transparent; border: 1px solid var(--border); border-radius: 20px; font-size: 0.78rem; font-weight: 600; cursor: pointer; transition: var(--transition); color: var(--text-2); font-family: var(--font-body); }
        .filter-pill:hover { border-color: var(--accent); color: var(--accent); }
        .filter-pill.active { background: var(--accent); color: white; border-color: var(--accent); }
        table { width: 100%; border-collapse: collapse; }
        thead { background: var(--bg-secondary); }
        th { padding: 0.7rem 1rem; text-align: left; font-size: 0.62rem; text-transform: uppercase; letter-spacing: 1.2px; color: var(--text-3); font-weight: 700; border-bottom: 1px solid var(--border); font-family: var(--font-mono); }
        td { padding: 0.75rem 1rem; border-bottom: 1px solid var(--border); font-size: 0.88rem; }
        tbody tr { transition: background var(--transition); }
        tbody tr:hover { background: var(--bg-card-hover); }
        .trade-type-badge { display: inline-block; padding: 0.2rem 0.6rem; border-radius: 4px; font-size: 0.65rem; font-weight: 700; text-transform: uppercase; font-family: var(--font-mono); letter-spacing: 0.5px; }
        .trade-type-badge.long { background: var(--green-dim); color: var(--green); }
        .trade-type-badge.short { background: var(--red-dim); color: var(--red); }
        .pnl-value { font-weight: 700; font-family: var(--font-mono); font-size: 0.88rem; }
        .pnl-value.positive { color: var(--green); }
        .pnl-value.negative { color: var(--red); }
        .btn-delete { background: transparent; border: 1px solid var(--border); color: var(--text-3); width: 28px; height: 28px; border-radius: 6px; cursor: pointer; font-size: 0.85rem; transition: var(--transition); display: inline-flex; align-items: center; justify-content: center; }
        .btn-delete:hover { border-color: var(--red); color: var(--red); background: var(--red-dim); }

        .trade-card { display: none; background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); padding: 1rem; margin-bottom: 0.6rem; }
        .trade-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; padding-bottom: 0.75rem; border-bottom: 1px solid var(--border); }
        .trade-card-body { display: grid; grid-template-columns: 1fr 1fr; gap: 0.65rem; font-size: 0.85rem; }
        .trade-card-label { font-size: 0.62rem; color: var(--text-3); text-transform: uppercase; letter-spacing: 0.5px; font-family: var(--font-mono); }
        .trade-card-value { font-weight: 600; }
        .trade-card-actions { margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid var(--border); display: flex; gap: 0.5rem; }

        /* MODAL */
        .modal { display: none; position: fixed; z-index: 1000; inset: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(8px); }
        .modal.active { display: flex; align-items: center; justify-content: center; animation: fadeUp 0.25s ease; }
        .modal-content { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 1.75rem; max-width: 560px; width: 92%; max-height: 88vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .modal-title { font-size: 1.15rem; font-weight: 700; font-family: var(--font-display); letter-spacing: -0.02em; }
        .modal-close { background: transparent; border: 1px solid var(--border); color: var(--text-2); width: 32px; height: 32px; border-radius: 8px; cursor: pointer; font-size: 1.1rem; display: flex; align-items: center; justify-content: center; transition: var(--transition); }
        .modal-close:hover { border-color: var(--red); color: var(--red); }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.85rem; margin-bottom: 0.85rem; }
        .form-group { display: flex; flex-direction: column; }
        .form-group.full-width { grid-column: span 2; }
        label { font-size: 0.65rem; color: var(--text-3); font-weight: 700; margin-bottom: 0.4rem; text-transform: uppercase; letter-spacing: 1px; font-family: var(--font-mono); }
        input, select, textarea { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; padding: 0.6rem 0.85rem; color: var(--text-1); font-family: var(--font-body); font-size: 0.88rem; transition: var(--transition); }
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-dim); }
        textarea { resize: vertical; min-height: 80px; }
        .checkbox-group { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; margin-bottom: 0.65rem; cursor: pointer; transition: var(--transition); }
        .checkbox-group:hover { border-color: var(--border-hover); }
        .checkbox-group input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; accent-color: var(--accent); }
        .checkbox-group label { margin: 0; cursor: pointer; text-transform: none; letter-spacing: normal; font-size: 0.85rem; font-weight: 500; color: var(--text-2); font-family: var(--font-body); }
        .checkbox-payout { border-color: rgba(239,68,68,0.2); background: var(--red-dim); }

        /* STATS */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
        .stat-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 1.25rem; }
        .stat-card-title { font-size: 0.65rem; color: var(--text-3); text-transform: uppercase; letter-spacing: 1.2px; font-weight: 700; margin-bottom: 1.25rem; font-family: var(--font-mono); }
        .comparison-boxes { display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; }
        .comparison-box { padding: 1.25rem; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: var(--radius); text-align: center; }
        .comparison-box.long { border-color: rgba(34,197,94,0.2); }
        .comparison-box.short { border-color: rgba(239,68,68,0.2); }
        .comparison-label { font-size: 0.65rem; color: var(--text-3); margin-bottom: 0.5rem; font-weight: 700; font-family: var(--font-mono); letter-spacing: 1px; }
        .comparison-value { font-size: 1.5rem; font-weight: 700; font-family: var(--font-display); margin-bottom: 0.3rem; letter-spacing: -0.02em; }
        .comparison-stats { font-size: 0.78rem; color: var(--text-2); }
        .day-performance { display: flex; flex-direction: column; gap: 0.65rem; }
        .day-row { display: flex; align-items: center; gap: 0.75rem; }
        .day-name { min-width: 60px; font-weight: 600; font-size: 0.82rem; color: var(--text-2); }
        .day-bar-container { flex: 1; height: 6px; background: var(--bg-secondary); border-radius: 3px; overflow: hidden; }
        .day-bar-fill { height: 100%; background: var(--accent); border-radius: 3px; transition: width 0.5s ease; }
        .day-value { min-width: 80px; text-align: right; font-weight: 700; font-family: var(--font-mono); font-size: 0.82rem; }
        .empty-state { text-align: center; padding: 3rem 1.5rem; color: var(--text-3); }
        .empty-icon { font-size: 2.5rem; margin-bottom: 0.75rem; opacity: 0.4; }

        .account-list { display: flex; flex-direction: column; gap: 0.5rem; margin-bottom: 1.25rem; }
        .account-item { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: var(--radius); padding: 0.85rem; cursor: pointer; transition: var(--transition); display: flex; justify-content: space-between; align-items: center; }
        .account-item:hover { border-color: var(--accent); }
        .account-item.active { border-color: var(--accent); background: var(--accent-dim); }
        .account-info h4 { font-size: 0.95rem; margin-bottom: 0.15rem; font-family: var(--font-display); }
        .account-info p { font-size: 0.78rem; color: var(--text-2); }
        .account-value { font-size: 1.15rem; font-weight: 700; font-family: var(--font-mono); }

        .desktop-text { }
        .mobile-text { display: none !important; }
        .playbook-progress-bar { height: 8px; background: var(--bg-secondary); border-radius: 4px; overflow: hidden; }
        .playbook-progress-fill { height: 100%; background: linear-gradient(90deg, var(--accent), #818CF8); border-radius: 4px; transition: width 0.4s ease; }

        /* RESPONSIVE */
        @media (max-width: 1200px) { .dashboard-grid { grid-template-columns: repeat(2, 1fr); } .dashboard-bottom { grid-template-columns: 1fr; } }
        @media (max-width: 768px) {
            .desktop-text { display: none !important; } .mobile-text { display: inline !important; }
            .sidebar { transform: translateX(-100%); } .sidebar.mobile-open { transform: translateX(0); box-shadow: 4px 0 20px rgba(0,0,0,0.5); }
            .main-content { margin-left: 0; width: 100%; } .mobile-menu-btn { display: flex; } .mobile-only { display: flex !important; }
            .account-selector { display: none; } .top-bar { padding: 0.75rem 1rem; } .page-title { font-size: 1rem; }
            .active-account-chip { display: none; } #googleUserBadge { display: none !important; }
            .content-area { padding: 0.85rem; } .dashboard-grid { grid-template-columns: 1fr 1fr; gap: 0.65rem; }
            .metric-card { padding: 1rem; } .metric-value { font-size: 1.3rem; } .metric-label { font-size: 0.6rem; margin-bottom: 0.5rem; }
            .form-grid { grid-template-columns: 1fr; } .form-group.full-width { grid-column: span 1; }
            .trades-header { flex-direction: column; align-items: flex-start; gap: 0.75rem; padding: 0.85rem; }
            .filter-pills { overflow-x: auto; flex-wrap: nowrap; width: 100%; } .filter-pill { white-space: nowrap; flex-shrink: 0; }
            table { display: none; } .trade-card { display: block; } #tradesCardsContainer, #payoutsCardsContainer { display: block !important; }
            .modal-content { width: 95%; padding: 1.25rem; max-height: 85vh; } .stats-grid { grid-template-columns: 1fr; }
            .account-item { flex-direction: column; align-items: flex-start; gap: 0.6rem; } .account-value { align-self: flex-end; font-size: 1rem; }
            .account-item .edit-account-btn, .account-item .burn-account-btn, .account-item .delete-account-btn { padding: 0.45rem 0.75rem !important; font-size: 0.78rem !important; min-height: 36px; min-width: 36px; display: inline-flex; align-items: center; justify-content: center; touch-action: manipulation; -webkit-tap-highlight-color: transparent; position: relative; z-index: 10; }
        }
        @media (max-width: 480px) { .dashboard-grid { grid-template-columns: 1fr 1fr; } .metric-value { font-size: 1.15rem; } .calendar-day { min-height: 44px; padding: 3px; } .calendar-day-pnl { font-size: 0.55rem; } .calendar-day-trades { display: none; } .btn { padding: 0.5rem 0.85rem; font-size: 0.8rem; } }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="mobile-overlay" id="mobileOverlay" onclick="journal.closeMobileMenu()"></div>
        <aside class="sidebar" id="sidebar">
            <div class="logo"><div class="logo-mark">TS</div><div class="logo-text">TradeScope <span>v2</span></div></div>
            <nav class="sidebar-menu">
                <div class="menu-section">
                    <div class="menu-label">Analytics</div>
                    <div class="menu-item active" data-view="dashboard"><span class="menu-icon">◈</span><span>Dashboard</span></div>
                    <div class="menu-item" data-view="trades"><span class="menu-icon">⬡</span><span>Trades</span></div>
                    <div class="menu-item" data-view="payouts"><span class="menu-icon">◇</span><span>Payouts</span></div>
                    <div class="menu-item" data-view="statistics"><span class="menu-icon">△</span><span>Stats Compte</span></div>
                    <div class="menu-item" data-view="globalStats"><span class="menu-icon">◎</span><span>Stats Globales</span></div>
                </div>
                <div class="menu-section">
                    <div class="menu-label">Outils</div>
                    <div class="menu-item mobile-only" onclick="journal.openAccountModal()"><span class="menu-icon">◉</span><span>Changer de Compte</span></div>
                    <div class="menu-item" data-view="journal"><span class="menu-icon">▤</span><span>Journal</span></div>
                    <div class="menu-item" data-view="playbook"><span class="menu-icon">▦</span><span>Playbook</span></div>
                </div>
            </nav>
            <div class="account-selector"><button class="account-btn" onclick="journal.openAccountModal()"><span id="currentAccountDisplay">Compte Principal</span><span>▾</span></button></div>
        </aside>
        <main class="main-content">
            <div class="top-bar">
                <div class="top-bar-left">
                    <button class="mobile-menu-btn" onclick="journal.toggleMobileMenu()">☰</button>
                    <h1 class="page-title" id="pageTitle">Dashboard</h1>
                    <div class="active-account-chip" id="topAccountDisplay" onclick="journal.openAccountModal()">
                        <div class="acc-dot"></div><span class="acc-name" id="topAccountName">Compte Principal</span><span class="acc-firm" id="topAccountFirm">Prop Firm</span>
                    </div>
                </div>
                <div class="top-actions">
                    <button class="btn-icon" onclick="journal.toggleTheme()" title="Thème"><span id="themeIcon">☀</span></button>
                    <button class="btn-icon" id="googleSignInBtn" onclick="journal.signInWithGoogle()" title="Google Drive">☁</button>
                    <div id="googleUserBadge" style="display:none;position:relative;">
                        <div style="cursor:pointer;" onclick="journal.toggleUserMenu()">
                            <div id="userAvatar" style="width:34px;height:34px;border-radius:8px;background:linear-gradient(135deg,var(--accent),#818CF8);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:0.75rem;color:white;">☁</div>
                            <div id="syncIndicator" style="position:absolute;bottom:-2px;right:-2px;width:10px;height:10px;background:var(--green);border:2px solid var(--bg-secondary);border-radius:50%;"></div>
                        </div>
                        <div id="userMenu" style="display:none;position:absolute;top:48px;right:0;background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);padding:0.5rem;min-width:200px;box-shadow:0 8px 24px rgba(0,0,0,0.3);z-index:1000;">
                            <div style="padding:0.65rem;border-bottom:1px solid var(--border);"><div style="font-weight:600;font-size:0.88rem;" id="googleUserNameMenu">User</div><div style="font-size:0.75rem;color:var(--text-2);" id="googleUserEmailMenu">email</div><div style="font-size:0.65rem;color:var(--green);margin-top:0.4rem;font-family:var(--font-mono);">● Sync OK</div></div>
                            <button onclick="journal.signOutFromTop()" style="width:100%;background:transparent;border:none;color:var(--red);padding:0.65rem;border-radius:6px;cursor:pointer;font-size:0.82rem;text-align:left;font-family:var(--font-body);">Déconnexion</button>
                        </div>
                    </div>
                    <button class="btn" onclick="journal.openTradeModal()"><span>+</span><span class="desktop-text">Nouveau Trade</span><span class="mobile-text">Trade</span></button>
                </div>
            </div>
            <div class="content-area">
                <!-- Dashboard -->
                <div id="dashboard" class="view active">
                    <div class="dashboard-grid">
                        <div class="metric-card"><div class="metric-label">Capital Actuel</div><div class="metric-value" id="widgetCapital">50 000 €</div><div class="metric-sub"><span class="tag up" id="widgetCapitalChange">▲ +0%</span></div></div>
                        <div class="metric-card"><div class="metric-label">P&L Total</div><div class="metric-value" id="widgetPnL" style="color:var(--text-2);">0 €</div><div class="metric-sub" id="widgetPnLChange">0 trades</div></div>
                        <div class="metric-card"><div class="metric-label">Win Rate</div><div class="metric-value" id="widgetWinRate">0%</div><div class="metric-sub" id="widgetWinRateChange">0W / 0L</div></div>
                        <div class="metric-card"><div class="metric-label">P&L Mensuel</div><div class="metric-value" id="widgetMonthlyPnL" style="color:var(--text-2);">0 €</div><div class="metric-sub" id="widgetMonthlyProgress">0%</div></div>
                    </div>
                    <div class="dashboard-bottom">
                        <div class="card"><div class="card-header"><span class="card-title" id="calendarMonth">Janvier 2025</span><div class="calendar-nav"><button onclick="journal.previousMonth()">◂</button><button onclick="journal.nextMonth()">▸</button></div></div><div class="card-body"><div class="calendar-grid" id="calendarGrid"></div></div></div>
                        <div class="card"><div class="card-header"><span class="card-title">Semaines</span></div><div class="card-body" id="weeksSummary"></div></div>
                    </div>
                </div>
                <!-- Trades -->
                <div id="trades" class="view">
                    <div class="trades-container">
                        <div class="trades-header"><span class="card-title">Historique des Trades</span><div class="filter-pills"><button class="filter-pill active" data-filter="all">Tous</button><button class="filter-pill" data-filter="month">Mois</button><button class="filter-pill" data-filter="week">Semaine</button><button class="filter-pill" data-filter="wins">Gains</button><button class="filter-pill" data-filter="losses">Pertes</button></div></div>
                        <table><thead><tr><th>Date</th><th>Instrument</th><th>Type</th><th>Taille</th><th>Risque</th><th>P&L</th><th>R:R</th><th>% Capital</th><th>Strat.</th><th>Chart</th><th></th></tr></thead><tbody id="tradesTableBody"><tr><td colspan="11" class="empty-state"><div class="empty-icon">◈</div><div>Aucun trade enregistré</div></td></tr></tbody></table>
                        <div id="tradesCardsContainer" style="padding:0.85rem;display:none;"></div>
                    </div>
                </div>
                <!-- Payouts -->
                <div id="payouts" class="view">
                    <div style="margin-bottom:1.5rem;"><h2 class="card-title" style="margin-bottom:0.35rem;font-size:1.1rem;">Historique des Payouts</h2><p style="color:var(--text-2);font-size:0.85rem;">Retraits — n'impactent pas les stats</p></div>
                    <div class="dashboard-grid" style="margin-bottom:1.5rem;">
                        <div class="metric-card"><div class="metric-label">Total (Compte)</div><div class="metric-value" id="payoutAccountTotal" style="color:var(--red);">0 €</div><div class="metric-sub" id="payoutAccountCount">0 payouts</div></div>
                        <div class="metric-card"><div class="metric-label">Total (Global)</div><div class="metric-value" id="payoutGlobalTotal" style="color:var(--red);">0 €</div><div class="metric-sub" id="payoutGlobalCount">0 payouts</div></div>
                        <div class="metric-card"><div class="metric-label">Dernier Payout</div><div class="metric-value" id="payoutLast" style="font-size:1.15rem;">—</div><div class="metric-sub" id="payoutLastDate">—</div></div>
                        <div class="metric-card"><div class="metric-label">Moyenne / Payout</div><div class="metric-value" id="payoutAverage">0 €</div><div class="metric-sub">Moyenne</div></div>
                    </div>
                    <div class="trades-container">
                        <div class="trades-header"><span class="card-title">Liste des Payouts</span><div class="filter-pills"><button class="filter-pill active" data-filter-payout="all">Tous</button><button class="filter-pill" data-filter-payout="month">Mois</button><button class="filter-pill" data-filter-payout="year">Année</button></div></div>
                        <table><thead><tr><th>Date</th><th>Compte</th><th>Montant</th><th>Cap. Avant</th><th>Cap. Après</th><th>Notes</th><th></th></tr></thead><tbody id="payoutsTableBody"><tr><td colspan="7" class="empty-state"><div class="empty-icon">◇</div><div>Aucun payout</div></td></tr></tbody></table>
                        <div id="payoutsCardsContainer" style="padding:0.85rem;display:none;"></div>
                    </div>
                </div>
                <!-- Stats Compte -->
                <div id="statistics" class="view">
                    <h2 class="card-title" style="margin-bottom:1.25rem;font-size:1.1rem;">Statistiques — <span id="statsAccountName"></span></h2>
                    <div class="stats-grid">
                        <div class="stat-card"><div class="stat-card-title">Performance par Jour</div><div class="day-performance" id="dayPerformance"></div></div>
                        <div class="stat-card"><div class="stat-card-title">Long vs Short</div><div class="comparison-boxes"><div class="comparison-box long"><div class="comparison-label">LONG</div><div class="comparison-value" id="statsLongPnL">0€</div><div class="comparison-stats" id="statsLongInfo">0 trades | 0% WR</div></div><div class="comparison-box short"><div class="comparison-label">SHORT</div><div class="comparison-value" id="statsShortPnL">0€</div><div class="comparison-stats" id="statsShortInfo">0 trades | 0% WR</div></div></div></div>
                        <div class="stat-card"><div class="stat-card-title">Respect Stratégie</div><div style="text-align:center;"><div style="font-size:2.5rem;font-weight:700;font-family:var(--font-display);margin-bottom:0.35rem;" id="statsStrategyPercent">0%</div><div style="color:var(--text-2);margin-bottom:1.25rem;font-size:0.85rem;" id="statsStrategyDetails">0 / 0 trades</div><div style="padding-top:1rem;border-top:1px solid var(--border);"><div class="stat-card-title" style="margin-bottom:0.4rem;">Avec stratégie</div><div id="statsWithStrategy" style="font-weight:700;margin-bottom:0.85rem;">—</div><div class="stat-card-title" style="margin-bottom:0.4rem;">Sans stratégie</div><div id="statsWithoutStrategy" style="font-weight:700;">—</div></div></div></div>
                        <div class="stat-card"><div class="stat-card-title">Meilleurs Instruments</div><div id="statsBestInstruments" style="display:flex;flex-direction:column;gap:0.5rem;"></div></div>
                        <div class="stat-card"><div class="stat-card-title">Risk:Reward</div><div style="text-align:center;"><div style="font-size:2.5rem;font-weight:700;font-family:var(--font-display);margin-bottom:0.35rem;" id="statsAvgRR">—</div><div style="color:var(--text-2);margin-bottom:1.25rem;font-size:0.85rem;" id="statsRRDetails">R:R moyen</div><div style="padding-top:1rem;border-top:1px solid var(--border);display:grid;grid-template-columns:1fr 1fr;gap:0.75rem;"><div><div class="stat-card-title" style="margin-bottom:0.4rem;">Meilleur R:R</div><div id="statsBestRR" style="font-weight:700;font-family:var(--font-mono);color:var(--green);">—</div></div><div><div class="stat-card-title" style="margin-bottom:0.4rem;">Pire R:R</div><div id="statsWorstRR" style="font-weight:700;font-family:var(--font-mono);color:var(--red);">—</div></div></div></div></div>
                    </div>
                </div>
                <!-- Stats Globales -->
                <div id="globalStats" class="view">
                    <h2 class="card-title" style="margin-bottom:1.25rem;font-size:1.1rem;">Stats Globales — Tous Comptes</h2>
                    <div class="dashboard-grid" style="margin-bottom:1.5rem;">
                        <div class="metric-card"><div class="metric-label">Capital Total</div><div class="metric-value" id="globalCapitalWidget">0€</div><div class="metric-sub" id="globalAccountsCount">0 comptes</div></div>
                        <div class="metric-card"><div class="metric-label">P&L Total</div><div class="metric-value" id="globalPnLWidget">0€</div><div class="metric-sub" id="globalTradesCount">0 trades</div></div>
                        <div class="metric-card"><div class="metric-label">Win Rate Global</div><div class="metric-value" id="globalWinRateWidget">0%</div><div class="metric-sub" id="globalWinRateDetails">0W / 0L</div></div>
                        <div class="metric-card"><div class="metric-label">Meilleur Compte</div><div class="metric-value" id="globalBestAccount" style="font-size:1.1rem;">—</div><div class="metric-sub" id="globalBestAccountPnL">0€</div></div>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-card"><div class="stat-card-title">Performance par Jour (Global)</div><div class="day-performance" id="globalDayPerformance"></div></div>
                        <div class="stat-card"><div class="stat-card-title">Long vs Short (Global)</div><div class="comparison-boxes"><div class="comparison-box long"><div class="comparison-label">LONG</div><div class="comparison-value" id="globalLongPnL">0€</div><div class="comparison-stats" id="globalLongInfo">0 trades | 0% WR</div></div><div class="comparison-box short"><div class="comparison-label">SHORT</div><div class="comparison-value" id="globalShortPnL">0€</div><div class="comparison-stats" id="globalShortInfo">0 trades | 0% WR</div></div></div></div>
                        <div class="stat-card"><div class="stat-card-title">Respect Stratégie (Global)</div><div style="text-align:center;"><div style="font-size:2.5rem;font-weight:700;font-family:var(--font-display);margin-bottom:0.35rem;" id="globalStrategyPercent">0%</div><div style="color:var(--text-2);margin-bottom:1.25rem;font-size:0.85rem;" id="globalStrategyDetails">0 / 0 trades</div><div style="padding-top:1rem;border-top:1px solid var(--border);"><div class="stat-card-title" style="margin-bottom:0.4rem;">Avec stratégie</div><div id="globalWithStrategy" style="font-weight:700;margin-bottom:0.85rem;">—</div><div class="stat-card-title" style="margin-bottom:0.4rem;">Sans stratégie</div><div id="globalWithoutStrategy" style="font-weight:700;">—</div></div></div></div>
                        <div class="stat-card"><div class="stat-card-title">Meilleurs Instruments (Global)</div><div id="globalBestInstruments" style="display:flex;flex-direction:column;gap:0.5rem;"></div></div>
                        <div class="stat-card"><div class="stat-card-title">Risk:Reward (Global)</div><div style="text-align:center;"><div style="font-size:2.5rem;font-weight:700;font-family:var(--font-display);margin-bottom:0.35rem;" id="globalAvgRR">—</div><div style="color:var(--text-2);margin-bottom:1.25rem;font-size:0.85rem;" id="globalRRDetails">R:R moyen</div><div style="padding-top:1rem;border-top:1px solid var(--border);display:grid;grid-template-columns:1fr 1fr;gap:0.75rem;"><div><div class="stat-card-title" style="margin-bottom:0.4rem;">Meilleur R:R</div><div id="globalBestRR" style="font-weight:700;font-family:var(--font-mono);color:var(--green);">—</div></div><div><div class="stat-card-title" style="margin-bottom:0.4rem;">Pire R:R</div><div id="globalWorstRR" style="font-weight:700;font-family:var(--font-mono);color:var(--red);">—</div></div></div></div></div>
                    </div>
                    <div style="margin-top:1.5rem;"><h2 class="card-title" style="margin-bottom:1rem;font-size:1rem;">Comparaison des Comptes</h2><div id="accountsComparison" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:1rem;"></div></div>
                </div>
                <!-- Journal -->
                <div id="journal" class="view"><div class="empty-state"><div class="empty-icon">▤</div><h3 style="font-family:var(--font-display);margin-bottom:0.5rem;">Journal de Trading</h3><p style="color:var(--text-2);">Fonctionnalité à venir...</p></div></div>
                <!-- Playbook -->
                <div id="playbook" class="view">
                    <div style="max-width:800px;margin:0 auto;">
                        <div style="margin-bottom:1.5rem;"><h2 class="card-title" style="margin-bottom:0.35rem;font-size:1.1rem;">Mon Playbook</h2><p style="color:var(--text-2);font-size:0.85rem;">Ta checklist personnalisée.</p></div>
                        <div class="dashboard-grid" style="grid-template-columns:repeat(3,1fr);margin-bottom:1.5rem;">
                            <div class="metric-card"><div class="metric-label">Respect Aujourd'hui</div><div class="metric-value" id="playbookTodayPercent" style="color:var(--accent);">0%</div><div class="metric-sub" id="playbookTodayCount">0 / 0 trades</div></div>
                            <div class="metric-card"><div class="metric-label">Respect Global</div><div class="metric-value" id="playbookGlobalPercent">0%</div><div class="metric-sub" id="playbookGlobalCount">0 / 0 trades</div></div>
                            <div class="metric-card"><div class="metric-label">Win Rate (Suivi)</div><div class="metric-value" id="playbookWinRate" style="color:var(--green);">0%</div><div class="metric-sub">Avec stratégie</div></div>
                        </div>
                        <div class="stat-card" style="margin-bottom:1rem;">
                            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;"><div class="stat-card-title" style="margin-bottom:0;">Checklist du Jour</div><button class="btn btn-outline" onclick="journal.resetDailyChecklist()" style="padding:0.4rem 0.75rem;font-size:0.78rem;">Reset</button></div>
                            <div id="dailyChecklistContainer"></div>
                        </div>
                        <div class="stat-card">
                            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;"><div class="stat-card-title" style="margin-bottom:0;">Mes Règles</div><button class="btn" onclick="journal.openAddRuleModal()" style="padding:0.4rem 0.75rem;font-size:0.78rem;">+ Ajouter</button></div>
                            <div id="playbookRulesList" style="display:flex;flex-direction:column;gap:0.5rem;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- MODALS -->
    <div id="tradeModal" class="modal"><div class="modal-content"><div class="modal-header"><h2 class="modal-title">Nouveau Trade</h2><button class="modal-close" onclick="journal.closeTradeModal()">×</button></div>
        <form id="tradeForm"><div class="form-grid">
            <div class="form-group"><label for="tradeDate">Date</label><input type="date" id="tradeDate" required></div>
            <div class="form-group"><label for="instrument">Instrument</label><select id="instrument"><option value="">Sélectionner...</option><optgroup label="Indices US"><option value="NASDAQ/MNQ">NASDAQ / MNQ</option><option value="SP500/MES">SP500 / MES</option><option value="DOWJONES/MYM">DOWJONES / MYM</option></optgroup><optgroup label="Forex Majeurs"><option value="EUR/USD">EUR/USD</option><option value="GBP/USD">GBP/USD</option><option value="USD/JPY">USD/JPY</option><option value="USD/CHF">USD/CHF</option><option value="AUD/USD">AUD/USD</option><option value="NZD/USD">NZD/USD</option><option value="USD/CAD">USD/CAD</option></optgroup><optgroup label="Forex Mineurs"><option value="EUR/GBP">EUR/GBP</option><option value="EUR/JPY">EUR/JPY</option><option value="GBP/JPY">GBP/JPY</option><option value="EUR/AUD">EUR/AUD</option><option value="EUR/CAD">EUR/CAD</option><option value="GBP/AUD">GBP/AUD</option></optgroup><optgroup label="Crypto"><option value="BTC/USD">BTC/USD</option><option value="ETH/USD">ETH/USD</option><option value="SOL/USD">SOL/USD</option><option value="XRP/USD">XRP/USD</option></optgroup><optgroup label="Matières Premières"><option value="GOLD/XAU">GOLD / XAU</option><option value="SILVER/XAG">SILVER / XAG</option><option value="OIL/WTI">OIL / WTI</option><option value="OIL/BRENT">OIL / BRENT</option></optgroup><option value="AUTRE">Autre</option></select></div>
            <div class="form-group" id="customInstrumentGroup" style="display:none;"><label for="customInstrument">Instrument personnalisé</label><input type="text" id="customInstrument" placeholder="Ex: EUR/GBP"></div>
            <div class="form-group"><label for="tradeType">Type</label><select id="tradeType"><option value="LONG">LONG</option><option value="SHORT">SHORT</option></select></div>
            <div class="form-group"><label for="pnl">P&L (€)</label><input type="number" id="pnl" step="0.01" placeholder="125.50" required></div>
            <div class="form-group"><label for="positionSize">Taille (lots)</label><input type="number" id="positionSize" step="0.01" placeholder="1.00"></div>
            <div class="form-group"><label for="riskAmount">Risque (€)</label><input type="number" id="riskAmount" step="0.01" placeholder="250.00"></div>
            <div class="form-group"><label for="tradingViewLink">Lien TradingView</label><input type="url" id="tradingViewLink" placeholder="https://..."></div>
            <div class="form-group full-width"><label for="notes">Notes</label><textarea id="notes" placeholder="Setup, émotions, observations..."></textarea></div>
        </div>
        <div class="checkbox-group"><input type="checkbox" id="followedStrategy"><label for="followedStrategy">J'ai suivi ma stratégie</label></div>
        <div class="checkbox-group checkbox-payout"><input type="checkbox" id="isPayout" onchange="journal.togglePayoutMode(this.checked)"><label for="isPayout">Payout (retrait — hors stats)</label></div>
        <button type="submit" class="btn" style="width:100%;padding:0.75rem;margin-top:0.5rem;">Enregistrer</button></form></div></div>

    <div id="accountModal" class="modal"><div class="modal-content"><div class="modal-header"><h2 class="modal-title">Mes Comptes</h2><button class="modal-close" onclick="journal.closeAccountModal()">×</button></div>
        <div class="account-list" id="accountList"></div><button class="btn btn-outline" onclick="journal.showAddAccountForm()" style="width:100%;">+ Nouveau Compte</button>
        <div id="addAccountForm" style="display:none;margin-top:1.25rem;padding-top:1.25rem;border-top:1px solid var(--border);"><form id="accountForm"><div class="form-group" style="margin-bottom:0.75rem;"><label for="accountName">Nom</label><input type="text" id="accountName" placeholder="Compte Principal" required style="width:100%;"></div><div class="form-group" style="margin-bottom:0.75rem;"><label for="propFirm">Prop Firm</label><input type="text" id="propFirm" placeholder="FTMO..." required style="width:100%;"></div><div class="form-group" style="margin-bottom:1rem;"><label for="accountCapital">Capital (€)</label><input type="number" id="accountCapital" placeholder="50000" required style="width:100%;"></div><div style="display:flex;gap:0.75rem;"><button type="submit" class="btn" style="flex:1;">Créer</button><button type="button" class="btn btn-outline" onclick="journal.hideAddAccountForm()" style="flex:1;">Annuler</button></div></form></div></div></div>

    <div id="dayTradesModal" class="modal"><div class="modal-content" style="max-width:720px;"><div class="modal-header"><h2 class="modal-title" id="dayTradesTitle">Trades du jour</h2><button class="modal-close" onclick="journal.closeDayTradesModal()">×</button></div><div id="dayTradesContainer"></div></div></div>
    <div id="editAccountModal" class="modal"><div class="modal-content" style="max-width:440px;"><div class="modal-header"><h2 class="modal-title">Éditer le compte</h2><button class="modal-close" onclick="journal.closeEditAccountModal()">×</button></div><form id="editAccountForm" onsubmit="journal.saveAccountEdit(event)"><div class="form-group" style="margin-bottom:0.75rem;"><label for="editAccountName">Nom</label><input type="text" id="editAccountName" required style="width:100%;"></div><div class="form-group" style="margin-bottom:1rem;"><label for="editAccountPropFirm">Prop Firm</label><input type="text" id="editAccountPropFirm" required style="width:100%;"></div><div style="display:flex;gap:0.75rem;"><button type="submit" class="btn" style="flex:1;">Enregistrer</button><button type="button" class="btn btn-outline" onclick="journal.closeEditAccountModal()" style="flex:1;">Annuler</button></div></form></div></div>
    <div id="addRuleModal" class="modal"><div class="modal-content" style="max-width:440px;"><div class="modal-header"><h2 class="modal-title">Ajouter une règle</h2><button class="modal-close" onclick="journal.closeAddRuleModal()">×</button></div><form id="addRuleForm" onsubmit="journal.addPlaybookRule(event)"><div class="form-group" style="margin-bottom:1rem;"><label for="ruleText">Règle</label><input type="text" id="ruleText" placeholder="Ex: Vérifier la tendance H4" required style="width:100%;"></div><div style="display:flex;gap:0.75rem;"><button type="submit" class="btn" style="flex:1;">Ajouter</button><button type="button" class="btn btn-outline" onclick="journal.closeAddRuleModal()" style="flex:1;">Annuler</button></div></form></div></div>

    <script>
    class TradingJournal {
        constructor() {
            this.accessToken = null; this.googleUser = null; this.driveFileId = null;
            this.currentTheme = localStorage.getItem('theme') || 'dark';
            this.currentView = 'dashboard'; this.currentMonth = new Date(); this.currentFilter = 'all';
            this.settings = this.loadSettings(); this.accounts = this.loadAccounts();
            this.currentAccountId = this.loadCurrentAccountId(); this.trades = this.loadTrades();
            this.playbookRules = this.loadPlaybookRules(); this.dailyChecklist = this.loadDailyChecklist();
            this.init();
        }
        init() { if(this.accounts.length===0) this.createDefaultAccount(); this.applyTheme(); this.setupEventListeners(); this.initGoogleDrive(); this.updateAllDisplays(); document.getElementById('tradeDate').valueAsDate=new Date(); }
        loadSettings() { const d={monthlyGoal:4,dailyGoal:0.2}; const s=localStorage.getItem('tradeJournalSettings'); return s?JSON.parse(s):d; }
        saveSettings() { localStorage.setItem('tradeJournalSettings',JSON.stringify(this.settings)); }
        loadAccounts() { const s=localStorage.getItem('tradeJournalAccounts'); return s?JSON.parse(s):[]; }
        saveAccounts() { localStorage.setItem('tradeJournalAccounts',JSON.stringify(this.accounts)); this.saveToDrive(); }
        loadCurrentAccountId() { const s=localStorage.getItem('currentAccountId'); return s?parseInt(s):null; }
        saveCurrentAccountId() { localStorage.setItem('currentAccountId',this.currentAccountId); }
        loadTrades() { const s=localStorage.getItem('tradeJournalTrades'); return s?JSON.parse(s):[]; }
        saveTrades() { localStorage.setItem('tradeJournalTrades',JSON.stringify(this.trades)); this.saveToDrive(); }
        createDefaultAccount() { const a={id:Date.now(),name:'Compte Principal',propFirm:'Personnel',baseCapital:50000,isBurned:false}; this.accounts.push(a); this.currentAccountId=a.id; this.saveAccounts(); this.saveCurrentAccountId(); }
        getCurrentAccount() { return this.accounts.find(a=>a.id===this.currentAccountId)||this.accounts[0]; }

        setupEventListeners() {
            document.querySelectorAll('.menu-item').forEach(i=>{ i.addEventListener('click',e=>{ const v=e.currentTarget.dataset.view; if(v) this.switchView(v); }); });
            document.getElementById('instrument').addEventListener('change',e=>{ const c=document.getElementById('customInstrumentGroup'); if(e.target.value==='AUTRE'){c.style.display='block';document.getElementById('customInstrument').required=true;}else{c.style.display='none';document.getElementById('customInstrument').required=false;} });
            document.getElementById('tradeForm').addEventListener('submit',e=>{e.preventDefault();this.addTrade();});
            document.getElementById('accountForm').addEventListener('submit',e=>{e.preventDefault();this.addAccount();});
            document.querySelectorAll('.filter-pill[data-filter]').forEach(p=>{ p.addEventListener('click',e=>{ document.querySelectorAll('.filter-pill[data-filter]').forEach(x=>x.classList.remove('active')); e.target.classList.add('active'); this.currentFilter=e.target.dataset.filter; this.renderTrades(); }); });
            document.addEventListener('click',e=>{ const um=document.getElementById('userMenu'),ua=document.getElementById('userAvatar'); if(um&&ua&&!um.contains(e.target)&&!ua.contains(e.target)) um.style.display='none'; });
        }

        switchView(v) { this.currentView=v; document.querySelectorAll('.menu-item').forEach(i=>i.classList.remove('active')); const m=document.querySelector(`[data-view="${v}"]`); if(m) m.classList.add('active'); document.querySelectorAll('.view').forEach(x=>x.classList.remove('active')); document.getElementById(v).classList.add('active'); const t={dashboard:'Dashboard',trades:'Trades',payouts:'Payouts',statistics:'Statistiques',globalStats:'Stats Globales',journal:'Journal',playbook:'Playbook'}; document.getElementById('pageTitle').textContent=t[v]; if(v==='statistics')this.updateStatistics();else if(v==='globalStats')this.updateGlobalStatistics();else if(v==='payouts')this.updatePayoutsView();else if(v==='playbook')this.renderPlaybookView(); this.closeMobileMenu(); }
        toggleMobileMenu() { document.getElementById('sidebar').classList.toggle('mobile-open'); document.getElementById('mobileOverlay').classList.toggle('active'); }
        closeMobileMenu() { document.getElementById('sidebar').classList.remove('mobile-open'); document.getElementById('mobileOverlay').classList.remove('active'); }
        openTradeModal() { document.getElementById('tradeModal').classList.add('active'); }
        closeTradeModal() { document.getElementById('tradeModal').classList.remove('active'); document.getElementById('tradeForm').reset(); document.getElementById('customInstrumentGroup').style.display='none'; this.togglePayoutMode(false); }
        togglePayoutMode(on) { ['instrument','tradeType','positionSize','riskAmount','tradingViewLink','followedStrategy'].forEach(id=>{document.getElementById(id).disabled=on;}); if(on){document.getElementById('instrument').value='';document.getElementById('positionSize').value='';document.getElementById('riskAmount').value='';document.getElementById('tradingViewLink').value='';document.getElementById('followedStrategy').checked=false;} }
        openAccountModal() { this.renderAccountList(); document.getElementById('accountModal').classList.add('active'); }
        closeAccountModal() { document.getElementById('accountModal').classList.remove('active'); this.hideAddAccountForm(); }
        showAddAccountForm() { document.getElementById('addAccountForm').style.display='block'; }
        hideAddAccountForm() { document.getElementById('addAccountForm').style.display='none'; document.getElementById('accountForm').reset(); }

        renderAccountList() {
            const list=document.getElementById('accountList'); const active=this.accounts.filter(a=>!a.isBurned); const burned=this.accounts.filter(a=>a.isBurned);
            let h=''; h+=active.map(a=>{const p=this.trades.filter(t=>t.accountId===a.id).reduce((s,t)=>s+t.pnl,0);const c=a.baseCapital+p;const act=a.id===this.currentAccountId;
            return `<div class="account-item ${act?'active':''}" onclick="if(event.target.closest('button'))return;journal.selectAccount(${a.id})"><div class="account-info"><h4>${a.name}</h4><p>${a.propFirm}</p></div><div style="text-align:right;"><div class="account-value" style="color:${p>=0?'var(--green)':'var(--red)'}">${this.formatCurrency(c)}</div><div style="display:flex;gap:0.35rem;margin-top:0.4rem;flex-wrap:wrap;justify-content:flex-end;"><button class="edit-account-btn" data-account-id="${a.id}" style="padding:0.2rem 0.5rem;background:transparent;border:1px solid var(--border);color:var(--text-2);border-radius:4px;cursor:pointer;font-size:0.7rem;">Éditer</button><button class="burn-account-btn" data-account-id="${a.id}" style="padding:0.2rem 0.5rem;background:transparent;border:1px solid var(--red);color:var(--red);border-radius:4px;cursor:pointer;font-size:0.7rem;">Griller</button><button class="delete-account-btn" data-account-id="${a.id}" style="padding:0.2rem 0.5rem;background:transparent;border:1px solid var(--red);color:var(--red);border-radius:4px;cursor:pointer;font-size:0.7rem;">×</button></div></div></div>`;}).join('');
            if(burned.length>0){h+=`<div style="margin:1rem 0 0.5rem;padding-top:1rem;border-top:1px solid var(--border);"><div style="font-size:0.62rem;color:var(--text-3);text-transform:uppercase;letter-spacing:1.5px;font-weight:600;font-family:var(--font-mono);">Grillés (${burned.length})</div></div>`;h+=burned.map(a=>{const p=this.trades.filter(t=>t.accountId===a.id).reduce((s,t)=>s+t.pnl,0);return `<div class="account-item" style="opacity:0.5;cursor:not-allowed;"><div class="account-info"><h4>${a.name} <span style="background:var(--red);color:white;padding:0.1rem 0.4rem;border-radius:3px;font-size:0.6rem;font-weight:700;">GRILLÉ</span></h4><p>${a.propFirm}</p></div><div style="text-align:right;"><div class="account-value" style="color:var(--text-3)">${this.formatCurrency(a.baseCapital+p)}</div><div style="display:flex;gap:0.35rem;margin-top:0.4rem;justify-content:flex-end;"><button class="burn-account-btn" data-account-id="${a.id}" style="padding:0.2rem 0.5rem;background:transparent;border:1px solid var(--green);color:var(--green);border-radius:4px;cursor:pointer;font-size:0.7rem;">Réactiver</button><button class="delete-account-btn" data-account-id="${a.id}" style="padding:0.2rem 0.5rem;background:transparent;border:1px solid var(--red);color:var(--red);border-radius:4px;cursor:pointer;font-size:0.7rem;">×</button></div></div></div>`;}).join('');}
            list.innerHTML=h;
            document.querySelectorAll('.edit-account-btn').forEach(b=>b.addEventListener('click',e=>{e.stopPropagation();e.preventDefault();this.editAccount(parseInt(b.dataset.accountId));}));
            document.querySelectorAll('.burn-account-btn').forEach(b=>b.addEventListener('click',e=>{e.stopPropagation();e.preventDefault();this.toggleBurnAccount(parseInt(b.dataset.accountId));}));
            document.querySelectorAll('.delete-account-btn').forEach(b=>b.addEventListener('click',e=>{e.stopPropagation();e.preventDefault();this.deleteAccount(parseInt(b.dataset.accountId));}));
        }

        selectAccount(id){const a=this.accounts.find(x=>x.id===id);if(a&&a.isBurned){alert('Compte grillé.');return;}this.currentAccountId=id;this.saveCurrentAccountId();this.closeAccountModal();this.updateAllDisplays();}
        editAccount(id){const a=this.accounts.find(x=>x.id===id);if(!a)return;this.editingAccountId=id;document.getElementById('editAccountName').value=a.name;document.getElementById('editAccountPropFirm').value=a.propFirm;document.getElementById('editAccountModal').classList.add('active');}
        closeEditAccountModal(){document.getElementById('editAccountModal').classList.remove('active');this.editingAccountId=null;}
        saveAccountEdit(e){e.preventDefault();const a=this.accounts.find(x=>x.id===this.editingAccountId);if(!a)return;a.name=document.getElementById('editAccountName').value.trim();a.propFirm=document.getElementById('editAccountPropFirm').value.trim();this.saveAccounts();this.renderAccountList();this.closeEditAccountModal();if(this.currentAccountId===this.editingAccountId)this.updateAllDisplays();}
        deleteAccount(id){const a=this.accounts.find(x=>x.id===id);if(!a)return;if(this.accounts.length===1){alert('Impossible.');return;}if(!confirm(`Supprimer "${a.name}" et tous ses trades ?`))return;this.trades=this.trades.filter(t=>t.accountId!==id);this.accounts=this.accounts.filter(x=>x.id!==id);if(this.currentAccountId===id){this.currentAccountId=this.accounts[0].id;this.saveCurrentAccountId();}this.saveAccounts();this.saveTrades();this.renderAccountList();this.updateAllDisplays();}
        toggleBurnAccount(id){const a=this.accounts.find(x=>x.id===id);if(!a)return;if(a.isBurned){if(confirm(`Réactiver "${a.name}" ?`)){a.isBurned=false;this.saveAccounts();this.renderAccountList();}}else{if(confirm(`Griller "${a.name}" ?`)){a.isBurned=true;if(this.currentAccountId===id){const act=this.accounts.filter(x=>!x.isBurned&&x.id!==id);if(act.length>0){this.currentAccountId=act[0].id;this.saveCurrentAccountId();}}this.saveAccounts();this.renderAccountList();this.updateAllDisplays();}}}
        addAccount(){const a={id:Date.now(),name:document.getElementById('accountName').value,propFirm:document.getElementById('propFirm').value,baseCapital:parseFloat(document.getElementById('accountCapital').value),isBurned:false};this.accounts.push(a);this.saveAccounts();this.hideAddAccountForm();this.renderAccountList();}

        addTrade(){let inst=document.getElementById('instrument').value;if(inst==='AUTRE')inst=document.getElementById('customInstrument').value.toUpperCase();const isPayout=document.getElementById('isPayout').checked;const risk=parseFloat(document.getElementById('riskAmount').value)||0;const trade={id:Date.now(),accountId:this.currentAccountId,date:document.getElementById('tradeDate').value,instrument:inst,type:document.getElementById('tradeType').value,pnl:parseFloat(document.getElementById('pnl').value),risk:risk,size:parseFloat(document.getElementById('positionSize').value),tradingViewLink:document.getElementById('tradingViewLink').value,followedStrategy:document.getElementById('followedStrategy').checked,notes:document.getElementById('notes').value,isPayout};if(isPayout&&trade.pnl>0)trade.pnl=-trade.pnl;trade.pnlPercent=(trade.pnl/this.getCurrentCapital())*100;if(risk>0)trade.rr=trade.pnl/risk;else trade.rr=null;this.trades.unshift(trade);this.saveTrades();this.closeTradeModal();this.updateAllDisplays();}
        deleteTrade(id){if(confirm('Supprimer ?')){this.trades=this.trades.filter(t=>t.id!==id);this.saveTrades();this.updateAllDisplays();}}
        getCurrentCapital(){const a=this.getCurrentAccount();return a.baseCapital+this.trades.filter(t=>t.accountId===this.currentAccountId).reduce((s,t)=>s+t.pnl,0);}
        getAccountTrades(){return this.trades.filter(t=>t.accountId===this.currentAccountId&&!t.isPayout);}
        getAccountPayouts(){return this.trades.filter(t=>t.accountId===this.currentAccountId&&t.isPayout);}
        getAllPayouts(){return this.trades.filter(t=>t.isPayout);}
        previousMonth(){this.currentMonth=new Date(this.currentMonth.getFullYear(),this.currentMonth.getMonth()-1);this.renderCalendar();}
        nextMonth(){this.currentMonth=new Date(this.currentMonth.getFullYear(),this.currentMonth.getMonth()+1);this.renderCalendar();}
        renderCalendar(){const ms=['Janvier','Février','Mars','Avril','Mai','Juin','Juillet','Août','Septembre','Octobre','Novembre','Décembre'];document.getElementById('calendarMonth').textContent=`${ms[this.currentMonth.getMonth()]} ${this.currentMonth.getFullYear()}`;const f=new Date(this.currentMonth.getFullYear(),this.currentMonth.getMonth(),1);const dim=new Date(this.currentMonth.getFullYear(),this.currentMonth.getMonth()+1,0).getDate();const sd=f.getDay();const g=document.getElementById('calendarGrid');g.innerHTML='';['Dim','Lun','Mar','Mer','Jeu','Ven','Sam'].forEach(d=>{const h=document.createElement('div');h.className='calendar-day-header';h.textContent=d;g.appendChild(h);});for(let i=0;i<sd;i++)g.appendChild(document.createElement('div'));const today=new Date();const at=this.getAccountTrades();for(let day=1;day<=dim;day++){const dd=new Date(this.currentMonth.getFullYear(),this.currentMonth.getMonth(),day);const dt=at.filter(t=>new Date(t.date).toDateString()===dd.toDateString());const dp=dt.reduce((s,t)=>s+t.pnl,0);const el=document.createElement('div');el.className='calendar-day';if(dd.toDateString()===today.toDateString())el.classList.add('today');if(dt.length>0){el.classList.add('has-trades');if(dp>0)el.classList.add('profit');if(dp<0)el.classList.add('loss');}el.innerHTML=`<div class="calendar-day-number">${day}</div>${dt.length>0?`<div class="calendar-day-pnl" style="color:${dp>=0?'var(--green)':'var(--red)'}">${dp>=0?'+':''}${dp.toFixed(0)}€</div><div class="calendar-day-trades">${dt.length}t</div>`:''}`;if(dt.length>0){el.onclick=()=>this.showDayTrades(dd,dt);}g.appendChild(el);}}

        showDayTrades(date,trades){const fd=date.toLocaleDateString('fr-FR',{weekday:'long',year:'numeric',month:'long',day:'numeric'});document.getElementById('dayTradesTitle').textContent=`Trades — ${fd}`;const tp=trades.reduce((s,t)=>s+t.pnl,0);const w=trades.filter(t=>t.pnl>0).length;const l=trades.filter(t=>t.pnl<0).length;document.getElementById('dayTradesContainer').innerHTML=`<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:0.75rem;margin-bottom:1.25rem;"><div class="metric-card" style="padding:0.85rem;"><div class="metric-label">P&L</div><div class="metric-value" style="font-size:1.3rem;color:${tp>=0?'var(--green)':'var(--red)'}">${tp>=0?'+':''}${this.formatCurrency(tp)}</div></div><div class="metric-card" style="padding:0.85rem;"><div class="metric-label">Trades</div><div class="metric-value" style="font-size:1.3rem;">${trades.length}</div></div><div class="metric-card" style="padding:0.85rem;"><div class="metric-label">W / L</div><div class="metric-value" style="font-size:1.3rem;"><span style="color:var(--green)">${w}</span>/<span style="color:var(--red)">${l}</span></div></div></div><div style="max-height:350px;overflow-y:auto;">${trades.map(t=>`<div style="display:flex;justify-content:space-between;align-items:center;padding:0.75rem;background:var(--bg-secondary);border:1px solid var(--border);border-radius:8px;margin-bottom:0.4rem;"><div><span style="font-weight:700;">${t.instrument||'-'}</span> <span class="trade-type-badge ${(t.type||'').toLowerCase()}">${t.type||'-'}</span></div><div class="pnl-value ${t.pnl>=0?'positive':'negative'}">${t.pnl>=0?'+':''}${t.pnl.toFixed(2)}€</div></div>`).join('')}</div>`;document.getElementById('dayTradesModal').classList.add('active');}
        closeDayTradesModal(){document.getElementById('dayTradesModal').classList.remove('active');}

        renderWeeksSummary(){const at=this.getAccountTrades();const now=new Date();let h='';for(let w=1;w<=4;w++){const wt=at.filter(t=>{const d=new Date(t.date);return d.getMonth()===now.getMonth()&&d.getFullYear()===now.getFullYear()&&this.getWeekNumber(t.date)===w;});const wp=wt.reduce((s,t)=>s+t.pnl,0);const ww=wt.filter(t=>t.pnl>0).length;h+=`<div class="week-item"><div class="week-label">Sem. ${w}</div><div class="week-pnl" style="color:${wp>=0?'var(--green)':'var(--red)'}">${wp>=0?'+':''}${this.formatCurrency(wp)}</div><div class="week-stats">${wt.length} trades · ${ww}W</div></div>`;}document.getElementById('weeksSummary').innerHTML=h;}
        getWeekNumber(date){const d=new Date(date);const f=new Date(d.getFullYear(),d.getMonth(),1);return Math.ceil((d.getDate()+f.getDay())/7);}

        filterTrades(){const now=new Date();const today=new Date(now.getFullYear(),now.getMonth(),now.getDate());const wa=new Date(today);wa.setDate(wa.getDate()-7);const ms=new Date(now.getFullYear(),now.getMonth(),1);return this.getAccountTrades().filter(t=>{const td=new Date(t.date);switch(this.currentFilter){case'month':return td>=ms;case'week':return td>=wa;case'wins':return t.pnl>0;case'losses':return t.pnl<0;default:return true;}});}

        renderTrades(){const tbody=document.getElementById('tradesTableBody');const ft=this.filterTrades();if(ft.length===0){tbody.innerHTML=`<tr><td colspan="11" class="empty-state"><div class="empty-icon">◈</div><div>Aucun trade trouvé</div></td></tr>`;const cc=document.getElementById('tradesCardsContainer');if(cc)cc.innerHTML=`<div class="empty-state"><div class="empty-icon">◈</div><div>Aucun trade</div></div>`;return;}
        tbody.innerHTML=ft.map(t=>{const rrVal=t.rr!=null?t.rr.toFixed(2):(t.risk&&t.risk>0?(t.pnl/t.risk).toFixed(2):'-');const rrColor=t.rr!=null?(t.rr>=0?'var(--green)':'var(--red)'):(t.risk&&t.risk>0?(t.pnl/t.risk>=0?'var(--green)':'var(--red)'):'var(--text-3)');return `<tr><td style="font-family:var(--font-mono);font-size:0.82rem;color:var(--text-2);">${new Date(t.date).toLocaleDateString('fr-FR')}</td><td style="font-weight:700;">${t.instrument||'-'}</td><td><span class="trade-type-badge ${(t.type||'').toLowerCase()}">${t.type||'-'}</span></td><td style="font-family:var(--font-mono);">${t.size||'-'}</td><td style="font-family:var(--font-mono);color:var(--amber);">${t.risk?t.risk.toFixed(0)+'€':'-'}</td><td class="pnl-value ${t.pnl>=0?'positive':'negative'}">${t.pnl>=0?'+':''}${t.pnl.toFixed(2)}€</td><td style="font-family:var(--font-mono);font-weight:700;color:${rrColor}">${rrVal!=='-'?rrVal+'R':'-'}</td><td style="color:${t.pnl>=0?'var(--green)':'var(--red)'};font-family:var(--font-mono);">${t.pnl>=0?'+':''}${t.pnlPercent.toFixed(2)}%</td><td style="text-align:center;">${t.followedStrategy?'<span style="color:var(--green)">✓</span>':'<span style="color:var(--red)">✗</span>'}</td><td>${t.tradingViewLink?`<a href="${t.tradingViewLink}" target="_blank" style="color:var(--accent);">↗</a>`:'-'}</td><td><button class="btn-delete" onclick="journal.deleteTrade(${t.id})">×</button></td></tr>`;}).join('');
        const cc=document.getElementById('tradesCardsContainer');if(cc)cc.innerHTML=ft.map(t=>{const rrVal=t.rr!=null?t.rr.toFixed(2):(t.risk&&t.risk>0?(t.pnl/t.risk).toFixed(2):'-');const rrColor=t.rr!=null?(t.rr>=0?'var(--green)':'var(--red)'):(t.risk&&t.risk>0?(t.pnl/t.risk>=0?'var(--green)':'var(--red)'):'var(--text-3)');return `<div class="trade-card"><div class="trade-card-header"><div><div style="font-weight:700;font-size:1rem;">${t.instrument||'-'}</div><div style="font-size:0.78rem;color:var(--text-2);font-family:var(--font-mono);">${new Date(t.date).toLocaleDateString('fr-FR')}</div></div><div class="pnl-value ${t.pnl>=0?'positive':'negative'}" style="font-size:1.15rem;">${t.pnl>=0?'+':''}${t.pnl.toFixed(2)}€</div></div><div class="trade-card-body"><div class="trade-card-field"><div class="trade-card-label">Type</div><div class="trade-card-value"><span class="trade-type-badge ${(t.type||'').toLowerCase()}">${t.type||'-'}</span></div></div><div class="trade-card-field"><div class="trade-card-label">Taille</div><div class="trade-card-value">${t.size||'-'}</div></div><div class="trade-card-field"><div class="trade-card-label">Risque</div><div class="trade-card-value" style="color:var(--amber);font-family:var(--font-mono);">${t.risk?t.risk.toFixed(0)+'€':'-'}</div></div><div class="trade-card-field"><div class="trade-card-label">R:R</div><div class="trade-card-value" style="color:${rrColor};font-family:var(--font-mono);font-weight:700;">${rrVal!=='-'?rrVal+'R':'-'}</div></div><div class="trade-card-field"><div class="trade-card-label">% Capital</div><div class="trade-card-value" style="color:${t.pnl>=0?'var(--green)':'var(--red)'};font-family:var(--font-mono);">${t.pnl>=0?'+':''}${t.pnlPercent.toFixed(2)}%</div></div><div class="trade-card-field"><div class="trade-card-label">Stratégie</div><div class="trade-card-value">${t.followedStrategy?'<span style="color:var(--green)">✓</span>':'<span style="color:var(--red)">✗</span>'}</div></div></div><div class="trade-card-actions">${t.tradingViewLink?`<a href="${t.tradingViewLink}" target="_blank" class="btn btn-outline" style="flex:1;text-align:center;padding:0.4rem;font-size:0.78rem;">Chart ↗</a>`:''}  <button onclick="journal.deleteTrade(${t.id})" class="btn" style="background:var(--red);flex:${t.tradingViewLink?'0':'1'};padding:0.4rem 0.75rem;font-size:0.78rem;">Suppr.</button></div></div>`;}).join('');}

        updateAllDisplays(){const a=this.getCurrentAccount();document.getElementById('currentAccountDisplay').textContent=a.isBurned?`${a.name} 🔥`:a.name;document.getElementById('topAccountName').textContent=a.name;document.getElementById('topAccountFirm').textContent=a.propFirm;this.updateWidgets();this.renderCalendar();this.renderWeeksSummary();this.renderTrades();}

        updateWidgets(){const a=this.getCurrentAccount();const at=this.getAccountTrades();const cap=this.getCurrentCapital();const tp=at.reduce((s,t)=>s+t.pnl,0);const cg=((cap-a.baseCapital)/a.baseCapital)*100;const w=at.filter(t=>t.pnl>0).length;const l=at.filter(t=>t.pnl<0).length;const wr=at.length>0?(w/at.length*100).toFixed(1):0;const now=new Date();const ms=new Date(now.getFullYear(),now.getMonth(),1);const mt=at.filter(t=>new Date(t.date)>=ms);const mp=mt.reduce((s,t)=>s+t.pnl,0);const mg=a.baseCapital*(this.settings.monthlyGoal/100);const mpg=(mp/mg*100).toFixed(1);document.getElementById('widgetCapital').textContent=this.formatCurrency(cap);document.getElementById('widgetCapitalChange').className=`tag ${cg>=0?'up':'down'}`;document.getElementById('widgetCapitalChange').textContent=`${cg>=0?'▲':'▼'} ${cg>=0?'+':''}${cg.toFixed(2)}%`;document.getElementById('widgetPnL').textContent=this.formatCurrency(tp);document.getElementById('widgetPnL').style.color=tp>=0?'var(--green)':'var(--red)';document.getElementById('widgetPnLChange').textContent=`${at.length} trades`;document.getElementById('widgetWinRate').textContent=`${wr}%`;document.getElementById('widgetWinRate').style.color=wr>=50?'var(--green)':'var(--red)';document.getElementById('widgetWinRateChange').textContent=`${w}W / ${l}L`;document.getElementById('widgetMonthlyPnL').textContent=this.formatCurrency(mp);document.getElementById('widgetMonthlyPnL').style.color=mp>=0?'var(--green)':'var(--red)';document.getElementById('widgetMonthlyProgress').textContent=`${mpg}% objectif`;}

        updateStatistics(){const a=this.getCurrentAccount();const at=this.getAccountTrades();document.getElementById('statsAccountName').textContent=a.name;const days=['Lundi','Mardi','Mercredi','Jeudi','Vendredi','Samedi','Dimanche'];const dp={};days.forEach(d=>dp[d]=0);at.forEach(t=>{const di=new Date(t.date).getDay();dp[days[di===0?6:di-1]]+=t.pnl;});const mx=Math.max(...Object.values(dp).map(Math.abs),1);document.getElementById('dayPerformance').innerHTML=days.map(d=>{const p=dp[d];return `<div class="day-row"><div class="day-name">${d.substring(0,3)}</div><div class="day-bar-container"><div class="day-bar-fill" style="width:${(Math.abs(p)/mx)*100}%;background:${p>=0?'var(--green)':'var(--red)'}"></div></div><div class="day-value" style="color:${p>=0?'var(--green)':'var(--red)'}">${p>=0?'+':''}${p.toFixed(0)}€</div></div>`;}).join('');const lt=at.filter(t=>t.type==='LONG');const st=at.filter(t=>t.type==='SHORT');const lp=lt.reduce((s,t)=>s+t.pnl,0);const sp=st.reduce((s,t)=>s+t.pnl,0);const lw=lt.filter(t=>t.pnl>0).length;const sw=st.filter(t=>t.pnl>0).length;const lwr=lt.length>0?(lw/lt.length*100).toFixed(0):0;const swr=st.length>0?(sw/st.length*100).toFixed(0):0;document.getElementById('statsLongPnL').textContent=this.formatCurrency(lp);document.getElementById('statsLongPnL').style.color=lp>=0?'var(--green)':'var(--red)';document.getElementById('statsLongInfo').textContent=`${lt.length} trades | ${lwr}% WR`;document.getElementById('statsShortPnL').textContent=this.formatCurrency(sp);document.getElementById('statsShortPnL').style.color=sp>=0?'var(--green)':'var(--red)';document.getElementById('statsShortInfo').textContent=`${st.length} trades | ${swr}% WR`;const ws=at.filter(t=>t.followedStrategy);const adh=at.length>0?(ws.length/at.length*100).toFixed(1):0;document.getElementById('statsStrategyPercent').textContent=`${adh}%`;document.getElementById('statsStrategyPercent').style.color=adh>=70?'var(--green)':'var(--red)';document.getElementById('statsStrategyDetails').textContent=`${ws.length} / ${at.length} trades`;const wsp=ws.reduce((s,t)=>s+t.pnl,0);const wsw=ws.filter(t=>t.pnl>0).length;const wswr=ws.length>0?(wsw/ws.length*100).toFixed(0):0;const wos=at.filter(t=>!t.followedStrategy);const wosp=wos.reduce((s,t)=>s+t.pnl,0);const wosw=wos.filter(t=>t.pnl>0).length;const woswr=wos.length>0?(wosw/wos.length*100).toFixed(0):0;document.getElementById('statsWithStrategy').innerHTML=`<span style="color:${wsp>=0?'var(--green)':'var(--red)'};font-size:1.1rem;font-family:var(--font-display);font-weight:700;">${this.formatCurrency(wsp)}</span> · ${wswr}% WR`;document.getElementById('statsWithoutStrategy').innerHTML=`<span style="color:${wosp>=0?'var(--green)':'var(--red)'};font-size:1.1rem;font-family:var(--font-display);font-weight:700;">${this.formatCurrency(wosp)}</span> · ${woswr}% WR`;const ip={};at.forEach(t=>{if(!ip[t.instrument])ip[t.instrument]=0;ip[t.instrument]+=t.pnl;});const si=Object.entries(ip).sort((a,b)=>b[1]-a[1]).slice(0,5);document.getElementById('statsBestInstruments').innerHTML=si.length>0?si.map(([i,p])=>`<div style="display:flex;justify-content:space-between;align-items:center;padding:0.65rem;background:var(--bg-secondary);border-radius:6px;"><span style="font-weight:600;">${i}</span><span style="font-family:var(--font-mono);font-weight:700;color:${p>=0?'var(--green)':'var(--red)'}">${p>=0?'+':''}${p.toFixed(0)}€</span></div>`).join(''):'<div style="color:var(--text-3);text-align:center;">Pas de données</div>';const rrTrades=at.filter(t=>{const rr=t.rr!=null?t.rr:(t.risk&&t.risk>0?t.pnl/t.risk:null);return rr!==null;});const rrValues=rrTrades.map(t=>t.rr!=null?t.rr:t.pnl/t.risk);if(rrValues.length>0){const avgRR=(rrValues.reduce((s,v)=>s+v,0)/rrValues.length).toFixed(2);const bestRR=Math.max(...rrValues).toFixed(2);const worstRR=Math.min(...rrValues).toFixed(2);document.getElementById('statsAvgRR').textContent=avgRR+'R';document.getElementById('statsAvgRR').style.color=avgRR>=0?'var(--green)':'var(--red)';document.getElementById('statsRRDetails').textContent=rrValues.length+' / '+at.length+' trades avec risque';document.getElementById('statsBestRR').textContent='+'+bestRR+'R';document.getElementById('statsWorstRR').textContent=worstRR+'R';}else{document.getElementById('statsAvgRR').textContent='\u2014';document.getElementById('statsAvgRR').style.color='var(--text-3)';document.getElementById('statsRRDetails').textContent='Aucun trade avec risque';document.getElementById('statsBestRR').textContent='\u2014';document.getElementById('statsWorstRR').textContent='\u2014';}}

        updateGlobalStatistics(){const at=this.trades.filter(t=>!t.isPayout);const tc=this.accounts.reduce((s,a)=>{const ap=this.trades.filter(t=>t.accountId===a.id).reduce((s2,t)=>s2+t.pnl,0);return s+a.baseCapital+ap;},0);const tp=at.reduce((s,t)=>s+t.pnl,0);const w=at.filter(t=>t.pnl>0).length;const l=at.filter(t=>t.pnl<0).length;const wr=at.length>0?(w/at.length*100).toFixed(1):0;let ba=null,bap=-Infinity;this.accounts.forEach(a=>{const ap=this.trades.filter(t=>t.accountId===a.id&&!t.isPayout).reduce((s,t)=>s+t.pnl,0);if(ap>bap){bap=ap;ba=a;}});document.getElementById('globalCapitalWidget').textContent=this.formatCurrency(tc);document.getElementById('globalAccountsCount').textContent=`${this.accounts.length} compte${this.accounts.length>1?'s':''}`;document.getElementById('globalPnLWidget').textContent=this.formatCurrency(tp);document.getElementById('globalPnLWidget').style.color=tp>=0?'var(--green)':'var(--red)';document.getElementById('globalTradesCount').textContent=`${at.length} trades`;document.getElementById('globalWinRateWidget').textContent=`${wr}%`;document.getElementById('globalWinRateWidget').style.color=wr>=50?'var(--green)':'var(--red)';document.getElementById('globalWinRateDetails').textContent=`${w}W / ${l}L`;if(ba){document.getElementById('globalBestAccount').textContent=ba.name;document.getElementById('globalBestAccountPnL').textContent=this.formatCurrency(bap);document.getElementById('globalBestAccountPnL').style.color=bap>=0?'var(--green)':'var(--red)';}const days=['Lundi','Mardi','Mercredi','Jeudi','Vendredi','Samedi','Dimanche'];const dp={};days.forEach(d=>dp[d]=0);at.forEach(t=>{const di=new Date(t.date).getDay();dp[days[di===0?6:di-1]]+=t.pnl;});const mx=Math.max(...Object.values(dp).map(Math.abs),1);document.getElementById('globalDayPerformance').innerHTML=days.map(d=>{const p=dp[d];return `<div class="day-row"><div class="day-name">${d.substring(0,3)}</div><div class="day-bar-container"><div class="day-bar-fill" style="width:${(Math.abs(p)/mx)*100}%;background:${p>=0?'var(--green)':'var(--red)'}"></div></div><div class="day-value" style="color:${p>=0?'var(--green)':'var(--red)'}">${p>=0?'+':''}${p.toFixed(0)}€</div></div>`;}).join('');const lt=at.filter(t=>t.type==='LONG');const st=at.filter(t=>t.type==='SHORT');const lp=lt.reduce((s,t)=>s+t.pnl,0);const sp=st.reduce((s,t)=>s+t.pnl,0);const lw=lt.filter(t=>t.pnl>0).length;const sw=st.filter(t=>t.pnl>0).length;document.getElementById('globalLongPnL').textContent=this.formatCurrency(lp);document.getElementById('globalLongPnL').style.color=lp>=0?'var(--green)':'var(--red)';document.getElementById('globalLongInfo').textContent=`${lt.length} trades | ${lt.length>0?(lw/lt.length*100).toFixed(0):0}% WR`;document.getElementById('globalShortPnL').textContent=this.formatCurrency(sp);document.getElementById('globalShortPnL').style.color=sp>=0?'var(--green)':'var(--red)';document.getElementById('globalShortInfo').textContent=`${st.length} trades | ${st.length>0?(sw/st.length*100).toFixed(0):0}% WR`;const ws=at.filter(t=>t.followedStrategy);const adh=at.length>0?(ws.length/at.length*100).toFixed(1):0;document.getElementById('globalStrategyPercent').textContent=`${adh}%`;document.getElementById('globalStrategyPercent').style.color=adh>=70?'var(--green)':'var(--red)';document.getElementById('globalStrategyDetails').textContent=`${ws.length} / ${at.length} trades`;const wsp=ws.reduce((s,t)=>s+t.pnl,0);const wsw=ws.filter(t=>t.pnl>0).length;const wswr=ws.length>0?(wsw/ws.length*100).toFixed(0):0;const wos=at.filter(t=>!t.followedStrategy);const wosp=wos.reduce((s,t)=>s+t.pnl,0);const wosw=wos.filter(t=>t.pnl>0).length;const woswr=wos.length>0?(wosw/wos.length*100).toFixed(0):0;document.getElementById('globalWithStrategy').innerHTML=`<span style="color:${wsp>=0?'var(--green)':'var(--red)'};font-size:1.1rem;font-family:var(--font-display);font-weight:700;">${this.formatCurrency(wsp)}</span> · ${wswr}% WR`;document.getElementById('globalWithoutStrategy').innerHTML=`<span style="color:${wosp>=0?'var(--green)':'var(--red)'};font-size:1.1rem;font-family:var(--font-display);font-weight:700;">${this.formatCurrency(wosp)}</span> · ${woswr}% WR`;const ip={};at.forEach(t=>{if(!ip[t.instrument])ip[t.instrument]=0;ip[t.instrument]+=t.pnl;});document.getElementById('globalBestInstruments').innerHTML=Object.entries(ip).sort((a,b)=>b[1]-a[1]).slice(0,5).map(([i,p])=>`<div style="display:flex;justify-content:space-between;align-items:center;padding:0.65rem;background:var(--bg-secondary);border-radius:6px;"><span style="font-weight:600;">${i}</span><span style="font-family:var(--font-mono);font-weight:700;color:${p>=0?'var(--green)':'var(--red)'}">${p>=0?'+':''}${p.toFixed(0)}€</span></div>`).join('')||'<div style="color:var(--text-3);text-align:center;">Pas de données</div>';const ac=this.accounts.map(a=>{const atr=this.trades.filter(t=>t.accountId===a.id&&!t.isPayout);const ap=atr.reduce((s,t)=>s+t.pnl,0);const aw=atr.filter(t=>t.pnl>0).length;const awr=atr.length>0?(aw/atr.length*100).toFixed(1):0;const allT=this.trades.filter(t=>t.accountId===a.id);const totalP=allT.reduce((s,t)=>s+t.pnl,0);return{a,ap,atr,awr,cap:a.baseCapital+totalP};}).sort((a,b)=>b.ap-a.ap);document.getElementById('accountsComparison').innerHTML=ac.map(({a,ap,atr,awr,cap})=>`<div style="background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-lg);padding:1.25rem;"><div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:0.75rem;"><div><h3 style="font-size:1rem;font-weight:700;font-family:var(--font-display);">${a.name}</h3><p style="font-size:0.82rem;color:var(--text-2);">${a.propFirm}</p></div><div style="text-align:right;"><div style="font-size:1.35rem;font-weight:700;font-family:var(--font-display);color:${ap>=0?'var(--green)':'var(--red)'}">${ap>=0?'+':''}${this.formatCurrency(ap)}</div><div style="font-size:0.82rem;color:var(--text-2);">${this.formatCurrency(cap)}</div></div></div><div style="display:flex;gap:1.5rem;font-size:0.85rem;"><div><span style="color:var(--text-2)">Trades:</span> <strong>${atr.length}</strong></div><div><span style="color:var(--text-2)">WR:</span> <strong style="color:${awr>=50?'var(--green)':'var(--red)'}">${awr}%</strong></div></div></div>`).join('');const grrTrades=at.filter(t=>{const rr=t.rr!=null?t.rr:(t.risk&&t.risk>0?t.pnl/t.risk:null);return rr!==null;});const grrValues=grrTrades.map(t=>t.rr!=null?t.rr:t.pnl/t.risk);if(grrValues.length>0){const gavgRR=(grrValues.reduce((s,v)=>s+v,0)/grrValues.length).toFixed(2);const gbestRR=Math.max(...grrValues).toFixed(2);const gworstRR=Math.min(...grrValues).toFixed(2);document.getElementById('globalAvgRR').textContent=gavgRR+'R';document.getElementById('globalAvgRR').style.color=gavgRR>=0?'var(--green)':'var(--red)';document.getElementById('globalRRDetails').textContent=grrValues.length+' / '+at.length+' trades avec risque';document.getElementById('globalBestRR').textContent='+'+gbestRR+'R';document.getElementById('globalWorstRR').textContent=gworstRR+'R';}else{document.getElementById('globalAvgRR').textContent='\u2014';document.getElementById('globalAvgRR').style.color='var(--text-3)';document.getElementById('globalRRDetails').textContent='Aucun trade avec risque';document.getElementById('globalBestRR').textContent='\u2014';document.getElementById('globalWorstRR').textContent='\u2014';}}

        toggleTheme(){this.currentTheme=this.currentTheme==='dark'?'light':'dark';localStorage.setItem('theme',this.currentTheme);this.applyTheme();}
        applyTheme(){document.documentElement.setAttribute('data-theme',this.currentTheme);const i=document.getElementById('themeIcon');if(i)i.textContent=this.currentTheme==='dark'?'☀':'☾';}

        async initGoogleDrive(){const st=localStorage.getItem('google_access_token');const su=localStorage.getItem('google_user');if(st&&su){this.accessToken=st;this.googleUser=JSON.parse(su);this.updateGoogleUI(true);await this.loadFromDrive();}}
        async signInWithGoogle(){try{const CID='5328933201-hhed8j3flifhdf4229sfof4247hugd1h.apps.googleusercontent.com';const client=google.accounts.oauth2.initTokenClient({client_id:CID,scope:'https://www.googleapis.com/auth/drive.file',callback:async(r)=>{if(r.access_token){this.accessToken=r.access_token;localStorage.setItem('google_access_token',r.access_token);const ui=await this.getUserInfo(r.access_token);this.googleUser=ui;localStorage.setItem('google_user',JSON.stringify(ui));this.updateGoogleUI(true);await this.loadFromDrive();alert('Connecte a Google Drive !');}}});client.requestAccessToken();}catch(e){console.error(e);alert('Erreur connexion Google');}}
        signOutFromTop(){if(confirm('Se deconnecter de Google Drive ?')){localStorage.removeItem('google_access_token');localStorage.removeItem('google_user');this.accessToken=null;this.googleUser=null;this.driveFileId=null;this.updateGoogleUI(false);}}
        updateGoogleUI(signedIn){const btn=document.getElementById('googleSignInBtn');const badge=document.getElementById('googleUserBadge');if(signedIn&&this.googleUser){btn.style.display='none';badge.style.display='flex';document.getElementById('userAvatar').textContent=this.getInitials(this.googleUser.name||'U');document.getElementById('googleUserNameMenu').textContent=this.googleUser.name;document.getElementById('googleUserEmailMenu').textContent=this.googleUser.email;}else{btn.style.display='flex';badge.style.display='none';}}
        getInitials(name){if(!name)return'U';const p=name.trim().split(' ');return p.length>=2?(p[0][0]+p[p.length-1][0]).toUpperCase():name.substring(0,2).toUpperCase();}
        toggleUserMenu(){const m=document.getElementById('userMenu');m.style.display=m.style.display==='none'||!m.style.display?'block':'none';}
        async getUserInfo(t){const r=await fetch('https://www.googleapis.com/oauth2/v2/userinfo',{headers:{Authorization:'Bearer '+t}});return await r.json();}

        async saveToDrive(){if(!this.accessToken)return;try{const data={settings:this.settings,accounts:this.accounts,currentAccountId:this.currentAccountId,trades:this.trades,lastSync:new Date().toISOString()};const content=JSON.stringify(data,null,2);const file=new Blob([content],{type:'application/json'});if(!this.driveFileId){const sr=await fetch('https://www.googleapis.com/drive/v3/files?q=name%3D%27tradescope-data.json%27+and+trashed%3Dfalse&fields=files(id,name)',{headers:{Authorization:'Bearer '+this.accessToken}});const res=await sr.json();if(res.files&&res.files.length>0)this.driveFileId=res.files[0].id;}const meta={name:'tradescope-data.json',mimeType:'application/json'};const form=new FormData();form.append('metadata',new Blob([JSON.stringify(meta)],{type:'application/json'}));form.append('file',file);const url=this.driveFileId?'https://www.googleapis.com/upload/drive/v3/files/'+this.driveFileId+'?uploadType=multipart':'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart';const r=await fetch(url,{method:this.driveFileId?'PATCH':'POST',headers:{Authorization:'Bearer '+this.accessToken},body:form});const result=await r.json();this.driveFileId=result.id;}catch(e){console.error('Drive save error:',e);}}

        async loadFromDrive(){if(!this.accessToken)return;try{const sr=await fetch('https://www.googleapis.com/drive/v3/files?q=name%3D%27tradescope-data.json%27+and+trashed%3Dfalse&fields=files(id,name)',{headers:{Authorization:'Bearer '+this.accessToken}});const res=await sr.json();if(!res.files||res.files.length===0)return;this.driveFileId=res.files[0].id;const fr=await fetch('https://www.googleapis.com/drive/v3/files/'+this.driveFileId+'?alt=media',{headers:{Authorization:'Bearer '+this.accessToken}});const data=await fr.json();if(data.settings)this.settings=data.settings;if(data.accounts)this.accounts=data.accounts;if(data.currentAccountId)this.currentAccountId=data.currentAccountId;if(data.trades)this.trades=data.trades;this.saveSettings();localStorage.setItem('tradeJournalAccounts',JSON.stringify(this.accounts));this.saveCurrentAccountId();localStorage.setItem('tradeJournalTrades',JSON.stringify(this.trades));this.updateAllDisplays();}catch(e){console.error('Drive load error:',e);}}

        updatePayoutsView(){const ap=this.getAccountPayouts();const allP=this.getAllPayouts();const at=ap.reduce((s,p)=>s+Math.abs(p.pnl),0);const gt=allP.reduce((s,p)=>s+Math.abs(p.pnl),0);document.getElementById('payoutAccountTotal').textContent=this.formatCurrency(at);document.getElementById('payoutAccountCount').textContent=ap.length+' payouts';document.getElementById('payoutGlobalTotal').textContent=this.formatCurrency(gt);document.getElementById('payoutGlobalCount').textContent=allP.length+' payouts';if(ap.length>0){document.getElementById('payoutLast').textContent=this.formatCurrency(Math.abs(ap[0].pnl));document.getElementById('payoutLastDate').textContent=new Date(ap[0].date).toLocaleDateString('fr-FR');}else{document.getElementById('payoutLast').textContent='\u2014';document.getElementById('payoutLastDate').textContent='\u2014';}document.getElementById('payoutAverage').textContent=this.formatCurrency(ap.length>0?at/ap.length:0);this.renderPayoutsTable();}

        renderPayoutsTable(){const tbody=document.getElementById('payoutsTableBody');const ap=this.getAccountPayouts();if(ap.length===0){tbody.innerHTML='<tr><td colspan="7" class="empty-state"><div class="empty-icon">\u25C7</div><div>Aucun payout</div></td></tr>';const cc=document.getElementById('payoutsCardsContainer');if(cc)cc.innerHTML='<div class="empty-state"><div class="empty-icon">\u25C7</div><div>Aucun payout</div></div>';return;}const am={};this.accounts.forEach(a=>am[a.id]=a.name);tbody.innerHTML=ap.map(p=>{const amt=Math.abs(p.pnl);return '<tr><td style="font-family:var(--font-mono);font-size:0.82rem;color:var(--text-2);">'+new Date(p.date).toLocaleDateString('fr-FR')+'</td><td style="font-weight:600;">'+(am[p.accountId]||'Compte')+'</td><td class="pnl-value negative">-'+this.formatCurrency(amt)+'</td><td>'+this.formatCurrency(this.getCurrentCapital()+amt)+'</td><td>'+this.formatCurrency(this.getCurrentCapital())+'</td><td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;">'+(p.notes||'-')+'</td><td><button class="btn-delete" onclick="journal.deleteTrade('+p.id+')">x</button></td></tr>';}).join('');const cc=document.getElementById('payoutsCardsContainer');if(cc)cc.innerHTML=ap.map(p=>'<div class="trade-card"><div class="trade-card-header"><div><div style="font-weight:700;">'+(am[p.accountId]||'Compte')+'</div><div style="font-size:0.78rem;color:var(--text-2);font-family:var(--font-mono);">'+new Date(p.date).toLocaleDateString('fr-FR')+'</div></div><div class="pnl-value negative" style="font-size:1.15rem;">-'+this.formatCurrency(Math.abs(p.pnl))+'</div></div><div style="font-size:0.85rem;color:var(--text-2);padding:0.5rem 0;">'+(p.notes||'\u2014')+'</div><div class="trade-card-actions"><button onclick="journal.deleteTrade('+p.id+')" class="btn" style="background:var(--red);flex:1;padding:0.4rem;font-size:0.78rem;">Suppr.</button></div></div>').join('');}

        loadPlaybookRules(){const s=localStorage.getItem('playbookRules');if(s)return JSON.parse(s);return[{id:1,text:"Verifier tendance H4/D1"},{id:2,text:"Setup valide identifie"},{id:3,text:"R/R minimum 2:1"},{id:4,text:"Risk management 1-2%"},{id:5,text:"Verifier les news"},{id:6,text:"Bonnes conditions mentales"}];}
        savePlaybookRules(){localStorage.setItem('playbookRules',JSON.stringify(this.playbookRules));this.saveToDrive();}
        loadDailyChecklist(){const s=localStorage.getItem('dailyChecklist');const sd=localStorage.getItem('dailyChecklistDate');const today=new Date().toDateString();if(sd!==today){localStorage.setItem('dailyChecklistDate',today);return{};}return s?JSON.parse(s):{};}
        saveDailyChecklist(){localStorage.setItem('dailyChecklist',JSON.stringify(this.dailyChecklist));}

        renderPlaybookView(){const rl=document.getElementById('playbookRulesList');if(this.playbookRules.length===0){rl.innerHTML='<div style="text-align:center;padding:2rem;color:var(--text-3);">Aucune regle.</div>';}else{rl.innerHTML=this.playbookRules.map(r=>'<div style="display:flex;align-items:center;justify-content:space-between;padding:0.85rem;background:var(--bg-secondary);border:1px solid var(--border);border-radius:8px;"><span style="font-weight:500;font-size:0.88rem;">'+r.text+'</span><button onclick="journal.deletePlaybookRule('+r.id+')" class="btn-delete">x</button></div>').join('');}this.renderDailyChecklist();this.updatePlaybookStats();}

        renderDailyChecklist(){const c=document.getElementById('dailyChecklistContainer');if(this.playbookRules.length===0){c.innerHTML='<div style="text-align:center;padding:2rem;color:var(--text-3);">Ajoute des regles.</div>';return;}const cc=Object.values(this.dailyChecklist).filter(v=>v).length;const pct=(cc/this.playbookRules.length*100).toFixed(0);c.innerHTML='<div style="margin-bottom:1.25rem;"><div style="display:flex;justify-content:space-between;margin-bottom:0.5rem;"><span style="color:var(--text-2);font-size:0.82rem;">Progression</span><span style="font-weight:700;color:var(--accent);font-family:var(--font-mono);">'+cc+' / '+this.playbookRules.length+'</span></div><div class="playbook-progress-bar"><div class="playbook-progress-fill" style="width:'+pct+'%"></div></div></div><div style="display:flex;flex-direction:column;gap:0.5rem;">'+this.playbookRules.map(r=>{const ch=this.dailyChecklist[r.id]||false;return '<label style="display:flex;align-items:center;gap:0.85rem;padding:0.85rem;background:'+(ch?'var(--green-dim)':'var(--bg-secondary)')+';border:1px solid '+(ch?'rgba(34,197,94,0.15)':'var(--border)')+';border-radius:8px;cursor:pointer;transition:var(--transition);"><input type="checkbox" '+(ch?'checked':'')+' onchange="journal.toggleDailyChecklistItem('+r.id+')" style="width:18px;height:18px;cursor:pointer;accent-color:var(--accent);"><span style="flex:1;font-weight:'+(ch?'600':'400')+';color:'+(ch?'var(--green)':'var(--text-1)')+';font-size:0.88rem;">'+r.text+'</span></label>';}).join('')+'</div>';}

        toggleDailyChecklistItem(id){this.dailyChecklist[id]=!this.dailyChecklist[id];this.saveDailyChecklist();this.renderDailyChecklist();this.updatePlaybookStats();}
        resetDailyChecklist(){if(confirm('Reset la checklist ?')){this.dailyChecklist={};this.saveDailyChecklist();this.renderDailyChecklist();this.updatePlaybookStats();}}

        updatePlaybookStats(){const at=this.getAccountTrades();const today=new Date().toDateString();const tt=at.filter(t=>new Date(t.date).toDateString()===today);const tw=tt.filter(t=>t.followedStrategy).length;const tp=tt.length>0?(tw/tt.length*100).toFixed(0):0;document.getElementById('playbookTodayPercent').textContent=tp+'%';document.getElementById('playbookTodayCount').textContent=tw+' / '+tt.length+' trades';const ws=at.filter(t=>t.followedStrategy).length;const gp=at.length>0?(ws/at.length*100).toFixed(0):0;document.getElementById('playbookGlobalPercent').textContent=gp+'%';document.getElementById('playbookGlobalCount').textContent=ws+' / '+at.length+' trades';const st=at.filter(t=>t.followedStrategy);const sw=st.filter(t=>t.pnl>0).length;const wr=st.length>0?(sw/st.length*100).toFixed(0):0;document.getElementById('playbookWinRate').textContent=wr+'%';}

        openAddRuleModal(){document.getElementById('addRuleModal').classList.add('active');}
        closeAddRuleModal(){document.getElementById('addRuleModal').classList.remove('active');document.getElementById('addRuleForm').reset();}
        addPlaybookRule(e){e.preventDefault();const t=document.getElementById('ruleText').value.trim();if(!t)return;this.playbookRules.push({id:Date.now(),text:t});this.savePlaybookRules();this.closeAddRuleModal();this.renderPlaybookView();}
        deletePlaybookRule(id){if(confirm('Supprimer cette regle ?')){this.playbookRules=this.playbookRules.filter(r=>r.id!==id);delete this.dailyChecklist[id];this.savePlaybookRules();this.saveDailyChecklist();this.renderPlaybookView();}}

        formatCurrency(v){return new Intl.NumberFormat('fr-FR',{style:'currency',currency:'EUR',minimumFractionDigits:0,maximumFractionDigits:0}).format(v);}
    }
    const journal = new TradingJournal();
    </script>
</body>
</html>
